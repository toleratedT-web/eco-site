{% extends "base.html" %}

{% block title %}Carbon Footprint Dashboard{% endblock %}

{% block content %}
  <h1 class="mb-4">Carbon Footprint Dashboard</h1>

  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card text-bg-primary mb-3">
          <div class="card-body">
            <h5 class="card-title">Total Footprint (kg CO₂e)</h5>
            <p id="totalFootprintsValue" class="card-text fs-3"></p>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card text-bg-success mb-3">
          <div class="card-body">
            <h5 class="card-title">Footprint Records Added Today</h5>
            <p id="footprintsRecordedValue" class="card-text fs-3"></p>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-4 justify-content-center">
      <div class="col-md-6">
        <div class="card mt-2">
          <div class="card-header">
            Top 5 Total Footprints
          </div>
          <div class="card-body">
            <canvas id="footprintsChart" height="170"></canvas>
          </div>
        </div>
      </div>
    
      <div class="col-md-6">
        <div class="card mt-2">
          <div class="card-header">
            Trend in the Total Footprint Recorded per day
          </div>
          <div class="card-body">
            <canvas id="footprintsTodayChart" height="170"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="row justify-content-center">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <strong>All Carbon Footprints</strong>
          </div>
          <div class="card-body p-0">
            <table class="table table-striped mb-0">
              <thead class="table-light">
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Car Emission</th>
                  <th>Electricity Emission</th>
                  <th>Total Footprint</th>
                  <th>Date</th>
                  <th>Delete</th>
                </tr>
              </thead>
              <tbody>
                {% for footprint in footprints %}
                  <tr>
                    <td>{{ footprint.id }}</td>
                    <td>{{ footprint.name }}</td>
                    <td>{{ footprint.car_emission }} kg CO₂e</td>
                    <td>{{ footprint.electricity_usage }} kg CO₂e</td>
                    <td>{{ footprint.total_footprint }} kg CO₂e</td>
                    <td>{{ footprint.date }}</td>
                    <td>
                      <form class="delete-btn" method="post" action="{{ url_for('main.delete', id=footprint.id) }}" novalidate>
                        <button type="submit" class="btn btn-sm">Delete</button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    fetch("{{ url_for('main.top_five_footprints') }}")
      .then(response => response.json())
      .then(data => {
        const labels = data.map(item => item.name);
        const values = data.map(item => item.total);

        const ctx = document.getElementById('footprintsChart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Total Footprint per person',
              data: values,
              backgroundColor: 'rgba(54, 162, 235, 0.6)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, title: { display: true, text: 'kg CO₂e' } } }
          }
        });
      });

    fetch("{{ url_for('main.total_footprints') }}")
      .then(response => response.json())
      .then(data => {
        const element = document.getElementById('totalFootprintsValue');
        element.innerText = data.total_footprints;
      });

    fetch("{{ url_for('main.footprints_recorded_today') }}")
      .then(response => response.json())
      .then(data => {
        const element = document.getElementById('footprintsRecordedValue');
        element.innerText = data.total;
      });

    fetch("{{ url_for('main.footprints_per_day') }}")
      .then(response => response.json())
      .then(data => {
        const labels = data.map(item => item.date);
        const values = data.map(item => item.total);

        const ctx = document.getElementById('footprintsTodayChart').getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Trend in Carbon Footprint',
              data: values,
              backgroundColor: 'rgba(54, 162, 235, 0.6)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, title: { display: true, text: 'kg CO₂e' } } }
          }
        });
      });
  </script>
{% endblock %}